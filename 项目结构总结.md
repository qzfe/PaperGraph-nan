# 论文知识图谱系统 - 项目结构总结

## 项目概述

本项目是一个基于 FastAPI 的论文知识图谱后端系统，采用三层架构设计（API - Service - DAO），使用 MySQL、Neo4j 和 Redis 作为数据存储和缓存层，通过 Celery 实现异步任务处理。

---

## 一、核心功能模块

### 1. 图谱展示模块 (Graph)

**功能说明**：提供知识图谱的可视化展示功能，包括根节点查询、节点展开/折叠、节点详情查看和布局保存。

**对应文件**：

#### API 层（路由层）
- `app/api/v1/graph.py` - 图谱相关的 REST API 接口
  - `GET /api/v1/graph/root` - 获取根节点图谱
  - `GET /api/v1/graph/children/{node_id}` - 展开/折叠节点
  - `GET /api/v1/graph/node/{node_id}` - 查看节点详情
  - `POST /api/v1/graph/layout/persist` - 保存节点布局

#### Service 层（业务逻辑层）
- `app/services/graph_service.py` - 图谱业务逻辑处理
  - 实现缓存策略（Redis）
  - 调用 DAO 层进行数据查询
  - 处理节点和边的数据转换

#### Repository 层（数据访问层）
- `app/repositories/neo4j_dao.py` - Neo4j 图数据库访问对象
  - `GraphDAO` 类：负责 Neo4j 的图数据查询
  - 查询根节点、子节点、节点详情
  - 保存节点布局信息

#### Schema 层（数据模型）
- `app/schemas/graph.py` - 图谱相关的请求/响应数据模型
  - `GraphResponse` - 图谱响应模型
  - `NodeSchema` - 节点模型
  - `EdgeSchema` - 边模型
  - `NodeDetailResponse` - 节点详情响应模型
  - `LayoutPersistRequest/Response` - 布局保存请求/响应模型

**数据存储**：
- **Neo4j** - 存储图结构数据（节点和关系）
- **Redis** - 缓存图谱查询结果

---

### 2. 数据统计模块 (Statistics)

**功能说明**：提供多维度数据统计分析功能，包括论文年份统计、作者排行、机构排行等，支持 Redis 缓存优化。

**对应文件**：

#### API 层（路由层）
- `app/api/v1/statistics.py` - 统计数据相关的 REST API 接口
  - `POST /api/v1/statistics/query` - 查询统计数据
  - `DELETE /api/v1/statistics/cache` - 清除统计缓存

#### Service 层（业务逻辑层）
- `app/services/statistics_service.py` - 统计业务逻辑处理
  - 实现缓存策略（Redis）
  - 生成缓存键
  - 调用 DAO 层进行数据聚合查询

#### Repository 层（数据访问层）
- `app/repositories/mysql_dao.py` - MySQL 数据访问对象
  - `StatisticsDAO` 类：负责 MySQL 的统计数据查询
  - 支持多种统计指标：
    - `paper_count_by_year` - 按年份统计论文数量
    - `top_authors` - 作者排行统计
    - `top_organizations` - 机构排行统计
    - 其他自定义统计指标

#### Schema 层（数据模型）
- `app/schemas/statistics.py` - 统计相关的请求/响应数据模型
  - `StatisticsQueryRequest` - 统计查询请求模型
  - `StatisticsQueryResponse` - 统计查询响应模型
  - `StatisticsDataPoint` - 统计数据点模型

**数据存储**：
- **MySQL** - 存储论文、作者、机构等关系型数据
- **Redis** - 缓存统计查询结果

---

### 3. 数据导出模块 (Export)

**功能说明**：提供数据导出功能，支持 CSV 和 Excel 格式，通过 Celery 异步任务处理大文件导出。

**对应文件**：

#### API 层（路由层）
- `app/api/v1/export.py` - 导出相关的 REST API 接口
  - `POST /api/v1/export/file` - 创建导出任务
  - `GET /api/v1/export/job/{job_id}` - 查询导出任务状态
  - `GET /api/v1/export/download/{job_id}` - 下载导出文件

#### Service 层（业务逻辑层）
- `app/services/export_service.py` - 导出业务逻辑处理
  - 创建导出任务
  - 查询任务状态
  - 更新任务状态

#### Repository 层（数据访问层）
- `app/repositories/mysql_dao.py` - MySQL 数据访问对象
  - `ExportDAO` 类：负责导出任务的数据访问
  - 插入导出任务记录
  - 查询任务状态
  - 更新任务状态和文件路径

#### Tasks 层（异步任务）
- `app/tasks/export_tasks.py` - Celery 异步导出任务
  - `generate_export_file` - 生成导出文件任务
  - `cleanup_old_files` - 清理旧文件任务
  - 支持导出类型：papers（论文）、authors（作者）、organizations（机构）、statistics（统计）

- `app/tasks/celery_app.py` - Celery 应用配置
  - Celery 实例初始化
  - 任务队列配置

#### Schema 层（数据模型）
- `app/schemas/export.py` - 导出相关的请求/响应数据模型
  - `ExportRequest` - 导出请求模型
  - `ExportJobResponse` - 导出任务响应模型
  - `ExportStatusResponse` - 导出状态响应模型

**数据存储**：
- **MySQL** - 存储导出任务日志（export_log 表）
- **文件系统** - 存储导出的 CSV/Excel 文件（exports 目录）
- **Redis** - Celery 消息代理和结果后端

---

## 二、基础设施模块

### 4. 数据库连接管理模块

**功能说明**：统一管理 MySQL、Neo4j 和 Redis 的数据库连接。

**对应文件**：
- `app/database.py` - 数据库连接管理
  - MySQL 连接管理（SQLAlchemy）
    - `engine` - SQLAlchemy 引擎
    - `SessionLocal` - 会话工厂
    - `get_db()` - 获取数据库会话的依赖注入函数
  - Neo4j 连接管理
    - `Neo4jConnection` 类：管理 Neo4j 驱动连接
    - `get_neo4j_driver()` - 获取 Neo4j 驱动
    - `get_neo4j_session()` - 获取 Neo4j 会话
  - Redis 连接管理
    - `RedisConnection` 类：管理 Redis 客户端连接
    - `get_redis_client()` - 获取 Redis 客户端
  - 数据库初始化函数
    - `init_db()` - 初始化所有数据库连接
    - `close_db()` - 关闭所有数据库连接

---

### 5. 数据模型模块

**功能说明**：定义 MySQL 数据库的表结构模型。

**对应文件**：
- `app/models/mysql_models.py` - MySQL 数据模型定义
  - `PaperInfo` - 论文信息表
  - `AuthorInfo` - 作者信息表
  - `OrganizationInfo` - 机构信息表
  - `PaperAuthorRelation` - 论文-作者关系表
  - `AuthorOrganizationRelation` - 作者-机构关系表
  - `PaperCitationRelation` - 论文引用关系表
  - `GraphNodeMapping` - 图节点映射表
  - `StatisticsData` - 统计数据表
  - `ExportLog` - 导出日志表

---

### 6. 配置管理模块

**功能说明**：管理系统配置信息，从环境变量读取配置。

**对应文件**：
- `config.py` - 系统配置文件
  - `Settings` 类：Pydantic 配置类
  - 应用配置（APP_NAME, DEBUG, HOST, PORT）
  - MySQL 配置
  - Neo4j 配置
  - Redis 配置
  - Celery 配置
  - 文件存储配置
  - JWT 配置

---

### 7. 应用入口模块

**功能说明**：FastAPI 应用的主入口，注册路由、中间件和生命周期事件。

**对应文件**：
- `app/main.py` - FastAPI 应用入口
  - 创建 FastAPI 应用实例
  - 配置 CORS 中间件
  - 注册 API 路由（graph, statistics, export）
  - 配置日志系统（Loguru）
  - 应用启动/关闭事件处理
  - 全局异常处理

---

### 8. 通用 Schema 模块

**功能说明**：定义通用的数据模型和响应格式。

**对应文件**：
- `app/schemas/common.py` - 通用数据模型
  - 通用响应模型
  - 分页模型
  - 错误响应模型

---

## 三、工具脚本模块

### 9. 数据库初始化脚本

**功能说明**：初始化数据库表结构、索引和约束。

**对应文件**：
- `scripts/init_database.py` - 数据库初始化脚本
  - 初始化 MySQL 表结构
  - 初始化 Neo4j 约束和索引
  - 测试 Redis 连接

---

### 10. 示例数据加载脚本

**功能说明**：加载示例数据到数据库，用于测试和演示。

**对应文件**：
- `scripts/load_sample_data.py` - 示例数据加载脚本
  - 加载论文数据
  - 加载作者数据
  - 加载机构数据
  - 建立关系数据

---

### 11. 数据爬取脚本（可选）

**功能说明**：从外部数据源爬取论文数据。

**对应文件**：
- `scripts/crawler.py` - 数据爬取脚本
  - 爬取论文信息
  - 数据清洗和转换
  - 导入到数据库

---

## 四、启动脚本

### 12. 环境设置脚本

**对应文件**：
- `setup.bat` - Windows 环境设置脚本
  - 创建虚拟环境
  - 安装依赖包

---

### 13. 服务启动脚本

**对应文件**：
- `start_server.bat` - 启动 FastAPI 服务器脚本
- `start_celery.bat` - 启动 Celery Worker 脚本

---

## 五、项目架构图

```
┌─────────────────────────────────────────────────────────┐
│                    FastAPI 应用层                        │
│                  (app/main.py)                          │
└─────────────────────────────────────────────────────────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
┌───────▼──────┐  ┌───────▼──────┐  ┌───────▼──────┐
│  Graph API   │  │ Statistics   │  │  Export API   │
│  (graph.py)  │  │  API         │  │  (export.py)  │
└───────┬──────┘  └───────┬──────┘  └───────┬──────┘
        │                  │                  │
┌───────▼──────┐  ┌───────▼──────┐  ┌───────▼──────┐
│ Graph Service│  │Statistics     │  │ Export       │
│              │  │Service        │  │ Service      │
└───────┬──────┘  └───────┬──────┘  └───────┬──────┘
        │                  │                  │
┌───────▼──────┐  ┌───────▼──────┐  ┌───────▼──────┐
│  GraphDAO    │  │ StatisticsDAO│  │  ExportDAO   │
│  (Neo4j)     │  │  (MySQL)     │  │  (MySQL)     │
└───────┬──────┘  └───────┬──────┘  └───────┬──────┘
        │                  │                  │
        └──────────────────┼──────────────────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
┌───────▼──────┐  ┌───────▼──────┐  ┌───────▼──────┐
│    Neo4j     │  │    MySQL     │  │    Redis     │
│  图数据库     │  │  关系数据库   │  │   缓存       │
└──────────────┘  └──────────────┘  └──────────────┘
                           │
                  ┌────────▼────────┐
                  │   Celery Worker │
                  │  (异步任务处理)  │
                  └─────────────────┘
```

---

## 六、文件结构总览

```
PaperGraph/
├── app/                          # 应用主目录
│   ├── __init__.py
│   ├── main.py                   # FastAPI 应用入口
│   ├── database.py               # 数据库连接管理
│   │
│   ├── api/                      # API 路由层
│   │   ├── __init__.py
│   │   └── v1/
│   │       ├── __init__.py
│   │       ├── graph.py          # 图谱 API
│   │       ├── statistics.py    # 统计 API
│   │       └── export.py         # 导出 API
│   │
│   ├── models/                   # 数据模型层
│   │   ├── __init__.py
│   │   └── mysql_models.py      # MySQL 表模型
│   │
│   ├── repositories/             # 数据访问层 (DAO)
│   │   ├── __init__.py
│   │   ├── mysql_dao.py         # MySQL DAO
│   │   └── neo4j_dao.py         # Neo4j DAO
│   │
│   ├── schemas/                  # 数据模型定义 (Pydantic)
│   │   ├── __init__.py
│   │   ├── common.py            # 通用模型
│   │   ├── graph.py             # 图谱模型
│   │   ├── statistics.py        # 统计模型
│   │   └── export.py            # 导出模型
│   │
│   ├── services/                 # 业务逻辑层
│   │   ├── __init__.py
│   │   ├── graph_service.py     # 图谱服务
│   │   ├── statistics_service.py # 统计服务
│   │   └── export_service.py    # 导出服务
│   │
│   └── tasks/                    # 异步任务
│       ├── __init__.py
│       ├── celery_app.py        # Celery 配置
│       └── export_tasks.py      # 导出任务
│
├── scripts/                       # 工具脚本
│   ├── __init__.py
│   ├── init_database.py         # 数据库初始化
│   ├── load_sample_data.py      # 示例数据加载
│   └── crawler.py               # 数据爬取
│
├── config.py                     # 系统配置
├── celery_worker.py              # Celery Worker 入口
├── requirements.txt              # Python 依赖
├── setup.bat                     # 环境设置脚本
├── start_server.bat              # 启动服务器脚本
├── start_celery.bat              # 启动 Celery 脚本
├── README.md                     # 项目说明文档
└── PROJECT_STATUS.md             # 项目状态文档
```

---

## 七、技术栈总结

### 后端框架
- **FastAPI 0.104.1** - 现代化 Python Web 框架
- **Uvicorn** - ASGI 服务器

### 数据库
- **MySQL 8.0+** - 关系型数据库（存储论文、作者、机构等结构化数据）
- **Neo4j 5.14+** - 图数据库（存储知识图谱的节点和关系）
- **Redis 7.0+** - 缓存数据库（缓存查询结果，Celery 消息代理）

### ORM 和驱动
- **SQLAlchemy 2.0.23** - Python ORM
- **PyMySQL** - MySQL 驱动
- **Neo4j Python Driver 5.14.1** - Neo4j 连接驱动

### 任务队列
- **Celery 5.3+** - 异步任务处理框架

### 其他工具
- **Pydantic** - 数据验证和设置管理
- **Loguru** - 日志记录
- **openpyxl** - Excel 文件处理

---

## 八、数据流向

### 图谱查询流程
```
客户端请求 → Graph API → Graph Service → GraphDAO (Neo4j) → 返回数据
                                    ↓
                               Redis 缓存
```

### 统计查询流程
```
客户端请求 → Statistics API → Statistics Service → StatisticsDAO (MySQL) → 返回数据
                                         ↓
                                    Redis 缓存
```

### 导出任务流程
```
客户端请求 → Export API → Export Service → 创建任务记录 (MySQL)
                                              ↓
                                    Celery Worker → 生成文件 → 更新任务状态
```

---

## 九、总结

本项目采用**三层架构**设计，清晰地分离了：
1. **API 层**：处理 HTTP 请求和响应
2. **Service 层**：实现业务逻辑和缓存策略
3. **Repository/DAO 层**：负责数据访问

主要功能模块包括：
- **图谱展示**：基于 Neo4j 的图数据查询和可视化
- **数据统计**：基于 MySQL 的多维度统计分析
- **数据导出**：基于 Celery 的异步文件导出

每个模块都遵循相同的架构模式，保证了代码的一致性和可维护性。



